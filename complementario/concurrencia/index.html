
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../5_contenedores/apuntes/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.14">
    
    
      
        <title>Concurrencia en iOS - IUDM-iOS-basico</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.10ba22f1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="Teal" data-md-color-accent="Teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#concurrencia-en-ios" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="IUDM-iOS-basico" class="md-header__button md-logo" aria-label="IUDM-iOS-basico" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IUDM-iOS-basico
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Concurrencia en iOS
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="IUDM-iOS-basico" class="md-nav__button md-logo" aria-label="IUDM-iOS-basico" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    IUDM-iOS-basico
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2_vistas/apuntes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vistas
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../2_vistas/ejercicios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ejercicios sobre vistas
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../3_autolayout/apuntes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Autolayout
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4_tablas/apuntes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tablas
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../4_tablas/ejercicios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ejercicios de tablas
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1_controllers/apuntes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Controladores
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../1_controllers/ejercicios/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ejercicios de controladores
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../5_contenedores/apuntes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Controladores contenedores
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Concurrencia en iOS
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Concurrencia en iOS
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concurrencia-en-ios" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrencia en iOS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Concurrencia en iOS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apis-de-concurrencia-en-ios-y-swift" class="md-nav__link">
    <span class="md-ellipsis">
      APIs de concurrencia en iOS y Swift
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#colas-de-operaciones" class="md-nav__link">
    <span class="md-ellipsis">
      Colas de operaciones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-cola-de-operaciones-principal-de-una-app" class="md-nav__link">
    <span class="md-ellipsis">
      La cola de operaciones principal de una app
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#concurrencia-en-ios" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrencia en iOS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Concurrencia en iOS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#apis-de-concurrencia-en-ios-y-swift" class="md-nav__link">
    <span class="md-ellipsis">
      APIs de concurrencia en iOS y Swift
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#colas-de-operaciones" class="md-nav__link">
    <span class="md-ellipsis">
      Colas de operaciones
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#la-cola-de-operaciones-principal-de-una-app" class="md-nav__link">
    <span class="md-ellipsis">
      La cola de operaciones principal de una app
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Concurrencia en iOS</h1>

<h2 id="concurrencia-en-ios">Concurrencia en iOS<a class="headerlink" href="#concurrencia-en-ios" title="Permanent link">&para;</a></h2>
<p>Una <em>app</em> iOS por defecto se ejecuta en un único <em>thread</em>, el principal, en el que corre nuestro código y el que actualiza la interfaz de usuario, recibe los eventos generados por éste, etc. En caso de realizar una operación costosa en tiempo en este hilo, como por ejemplo cargar gran cantidad de datos de un servidor, se paralizaría la interfaz de usuario hasta que terminara la operación.</p>
<h3 id="apis-de-concurrencia-en-ios-y-swift">APIs de concurrencia en iOS y Swift<a class="headerlink" href="#apis-de-concurrencia-en-ios-y-swift" title="Permanent link">&para;</a></h3>
<p>Tanto iOS como OSX tienen varios APIs con distinto nivel de abstracción para trabajar con operaciones concurrentes:</p>
<ul>
<li>En el nivel más bajo estaría trabajar directamente con <em>threads</em>, representados por la clase del sistema <code>NSThread</code>. La mayoría de aplicaciones no necesitan la flexibilidad que nos proporciona trabajar a este nivel, o no merece la pena teniendo en cuenta lo complicado del código con respecto a las otras alternativas.</li>
<li>En un nivel intermedio tenemos un <em>framework</em> de Apple llamado <em>grand central dispatch</em> o GCD. Tiene un nivel de abstracción razonable para la mayoría de aplicaciones, de hecho en Internet podéis encontrar multitud de tutoriales y ejemplos que lo usan (podéis verlo por la llamada a una función llamada <code>dispatch_async</code>, que pone en marcha código concurrente).</li>
<li>En el nivel más alto de abstracción están las <em>colas de operaciones</em> (aunque no es mucho mayor que GCD). Es el API que vamos a explicar aquí ya que es el más sencillo de usar.</li>
</ul>
<p>Cada API usa internamente los otros de más bajo nivel. Es decir, GCD usa internamente <em>threads</em> y las colas de operaciones usan internamente GCD.</p>
<p>En el 2021 se introdujo el soporte para concurrencia de forma nativa en el propio lenguaje de desarrollo usado en iOS, en Swift. Se gestiona con construcciones como <code>async/await</code> y <code>Task</code>, similares a las de otros lenguajes como C# y Javascript. Al final del tema veremos brevemente estos mecanismos y las ventajas que aportan.</p>
<h3 id="colas-de-operaciones">Colas de operaciones<a class="headerlink" href="#colas-de-operaciones" title="Permanent link">&para;</a></h3>
<p>En una <em>cola de operaciones</em> podemos añadir trabajos concurrentes. Manejarlas a nivel básico es muy sencillo. Son instancias de <code>OperationQueue</code> y para añadir un trabajo a una solo hay que llamar a <code>addOperation()</code>. Hay diversas formas de pasar el código a ejecutar. La más cómoda es en forma de <em>clausura</em>. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span> <span class="nv">cola</span> <span class="p">=</span> <span class="n">OperationQueue</span><span class="p">();</span>
<span class="n">cola</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;comienza operación 1...&quot;</span><span class="p">);</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;...hecho 1&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">cola</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;comienza operacion 2...&quot;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;...hecho 2&quot;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div>
<blockquote>
<p>NOTA: podemos ver el resultado del código anterior añadiéndolo por ejemplo a una aplicación iOS. Si usamos una aplicación de línea de comandos tendremos que añadir algo al código ya que si no el programa principal terminaría inmediatamente después del segundo <code>addOperation</code> y no se verían los mensajes en pantalla. Por ejemplo podemos llamar a <code>cola.waitUntilAllOperationsAreFinished()</code>  que como su propio nombre indica se espera hasta que todas las operaciones añadidas a la cola han terminado.</p>
</blockquote>
<p>Si ejecutamos el código anterior veremos que aunque el código de la primera clausura comienza a ejecutarse primero, aun así termina después, es decir, ambas "tareas" se están ejecutando en paralelo y no secuencialmente. Por defecto este es el comportamiento de las colas de operaciones, aunque podemos definir dependencias entre tareas, de modo que se ejecute una solo cuando ha acabado otra determinada. Incluso podemos limitar el número de operaciones concurrentes que se pueden ejecutar en una cola.</p>
<h3 id="la-cola-de-operaciones-principal-de-una-app">La cola de operaciones principal de una <em>app</em><a class="headerlink" href="#la-cola-de-operaciones-principal-de-una-app" title="Permanent link">&para;</a></h3>
<p>En aplicaciones iOS está predefinida lo que se llama la "cola de operaciones principal", que es la que ejecuta el código que actualiza la interfaz de usuario. Podemos acceder a ella con <code>OperationQueue.main</code>. Esta cola de operaciones no puede ejecutar operaciones concurrentes para evitar inconsistencias, que se podrían dar si dos tareas estuvieran modificando simultáneamente el mismo elemento de la interfaz. Podemos comprobar esto imprimiendo el valor de <code>OperationQueue.main.maxConcurrentOperationCount</code>, que veremos que vale 1, es decir, no hay operaciones concurrentes en esta cola.</p>
<p>Cuando necesitamos ejecutar una operación especialmente costosa en tiempo no es recomendable bloquear la interfaz de usuario, por lo que se suele crear una cola de operaciones aparte de la principal y ejecutar la operación en esta.  </p>
<p>Un problema adicional es que normalmente esta operación costosa debe actualizar la interfaz de usuario al finalizar, pero ningún hilo de ejecución que no sea el principal debe actualizar la interfaz de usuario, ya que lo contrario podría producir resultados inconsistentes. Esto lo podemos resolver accediendo a la cola de operaciones principal con <code>OperationQueue.main</code>. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span> <span class="nv">background</span> <span class="p">=</span> <span class="n">OperationQueue</span><span class="p">();</span>
<span class="n">background</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Comienzo mi duro trabajo...&quot;</span><span class="p">)</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;...terminado!&quot;</span><span class="p">)</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;pero yo NO DEBO tocar la interfaz&quot;</span><span class="p">)</span>
    <span class="n">OperationQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">addOperation</span><span class="p">()</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Soy main. Desde aquí sí se puede actualizar la interfaz&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.bd41221c.min.js"></script>
      
    
  </body>
</html>